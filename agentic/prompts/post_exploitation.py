"""
RedAmon Post-Exploitation Prompts

Prompts for post-exploitation phase with different session types.
"""


# =============================================================================
# POST-EXPLOITATION TOOLS (Statefull Mode - Meterpreter)
# =============================================================================

POST_EXPLOITATION_TOOLS_STATEFULL = """
### Post-Exploitation Phase Tools (Statefull Mode - Meterpreter)

You have an active Meterpreter session. Use `metasploit_console` for all operations.

## Context Detection (check PREVIOUS output)

| Prompt | Context | Next Action |
|--------|---------|-------------|
| `meterpreter >` | Meterpreter | Run meterpreter commands |
| `msf6 >` | MSF console | `sessions -i 1` to re-enter |
| `$` or `#` | OS shell | `exit` to return to meterpreter |

## Quick Reference: Meterpreter vs Shell

**USE METERPRETER FOR:**
- Stealth (in-memory, no disk writes)
- Pivoting: `portfwd`, `route add`
- Process migration: `migrate <PID>`
- Windows privesc: `getsystem`
- Post modules: `run post/multi/gather/...`
- File transfer: `upload`, `download`

**DROP TO SHELL FOR:**
- File writes: `echo 'x' > file` (meterpreter has NO echo!)
- Native commands: `grep`, `find`, `awk`, `sed`
- Minimal containers (Docker/Alpine) where stdapi fails

## CRITICAL: stdapi Failure Recovery

**If you see:** `stdapi_fs_stat: Operation failed: 1` or empty output from `ls`/`pwd`

**DO NOT RETRY.** Drop to shell immediately:
```
shell
echo 'content' > /path/file
exit
```

## Meterpreter Commands (subset - no shell equivalents!)

| Command | Purpose | Shell Equivalent |
|---------|---------|------------------|
| `sysinfo` | System info | `uname -a` |
| `getuid` | Current user | `whoami` |
| `pwd` / `ls` / `cd` | Navigation | Same |
| `cat /path` | Read file | Same |
| `download /path` | Copy to attacker | `scp` |
| `upload local remote` | Copy to target | `scp` |
| `ps` | Process list | `ps aux` |
| `migrate <PID>` | Move to process | N/A |
| `hashdump` | Dump hashes (Win) | N/A |
| `portfwd add -l 4444 -p 80 -r target` | Port forward | N/A |

**NOT in Meterpreter:** `echo`, `grep`, `awk`, `sed`, `chmod`, `chown` -> use `shell`

## File Modification (in order of preference)

1. **Shell (simple writes):** `shell` -> `echo 'x' > file` -> `exit`
2. **Meterpreter upload:** `upload /tmp/local /remote/path`
3. **Meterpreter execute:** `execute -f /bin/sh -a '-c "echo x > file"'`

## Session Management (from msf6 > only)

```
background          -> Return to msf console (keeps session)
sessions -l         -> List sessions
sessions -i 1       -> Re-enter session 1
sessions -k 1       -> Kill session 1
```

## Error Handling

| Error | Cause | Action |
|-------|-------|--------|
| `stdapi_fs_*: Operation failed` | Minimal container/restricted env | Drop to `shell` |
| `No active sessions` | Session died | Inform user, offer re-exploit |
| `Unknown command: X` | Using shell cmd in meterpreter | Drop to `shell` first |

## Ask User Before Impactful Actions

Use `action="ask_user"` before: privilege escalation, data exfiltration, persistence, file modifications, lateral movement.
"""


# =============================================================================
# POST-EXPLOITATION TOOLS (Shell Session - from Brute Force)
# =============================================================================

POST_EXPLOITATION_TOOLS_SHELL = """
### Post-Exploitation Phase Tools (Shell Session from SSH Brute Force)

You have an active **shell session** (NOT Meterpreter) from successful SSH brute force.
Use `metasploit_console` for all session interactions.

## CRITICAL: This is a SHELL, not Meterpreter!

**DO NOT use Meterpreter commands.** They will fail!

| Works (Shell) | Does NOT Work (Meterpreter) |
|---------------|----------------------------|
| `whoami` | `getuid` |
| `id` | `getpid` |
| `uname -a` | `sysinfo` |
| `cat /etc/passwd` | `cat` (Meterpreter's cat is different) |
| `ls -la` | `ls` (Meterpreter's ls is different) |
| `pwd` | Works in both, but different output format |
| `echo 'text' > file` | N/A - meterpreter has no echo |
| `ps aux` | `ps` (Meterpreter version) |
| `netstat -tulpn` | N/A |

## Session Interaction

```
sessions -l           -> List all sessions
sessions -i <id>      -> Interact with session (drops into shell)
                         Prompt changes to $ or #
```

When you run `sessions -i <id>`, you are now in a Linux/Unix shell.
All commands are standard shell commands, NOT Meterpreter commands.

## Common Post-Exploitation Commands (in shell)

### Information Gathering
```
whoami && id                    -> Current user and groups
uname -a                        -> Kernel and OS info
cat /etc/passwd                 -> List users
cat /etc/shadow                 -> Password hashes (if root)
sudo -l                         -> Check sudo permissions
cat /etc/crontab                -> Scheduled tasks
ps aux                          -> Running processes
netstat -tulpn                  -> Network connections
```

### File Operations
```
find / -perm -4000 2>/dev/null  -> Find SUID binaries
find / -writable -type f 2>/dev/null -> Writable files
ls -la /home/                   -> Home directories
cat /home/*/.ssh/id_rsa         -> SSH private keys
cat /home/*/.bash_history       -> Command history
```

### Privilege Escalation Recon
```
cat /etc/os-release             -> OS version (for kernel exploits)
dpkg -l 2>/dev/null | head -20  -> Installed packages (Debian)
rpm -qa 2>/dev/null | head -20  -> Installed packages (RedHat)
getcap -r / 2>/dev/null         -> Files with capabilities
```

### Network Reconnaissance
```
ip addr                         -> Network interfaces
ip route                        -> Routing table
cat /etc/hosts                  -> Host file
cat /etc/resolv.conf            -> DNS configuration
ss -tulpn                       -> Open sockets
arp -a                          -> ARP table
```

## Returning to MSF Console

When in shell session:
```
exit                            -> Exit shell, return to msf console
                                   (or Ctrl+C if stuck)
```

**NOTE:** `background` command is NOT available in shell sessions!
Unlike Meterpreter, you cannot background a shell session.
Use `exit` to close the shell and return to msf6 console.

## Session-Based Routing (from msf6 console)

After exiting back to msf6 console:
```
sessions -l                     -> List sessions
sessions -u <id>                -> Upgrade shell to Meterpreter (if possible)
sessions -k <id>                -> Kill session
```

**Upgrading Shell to Meterpreter (optional):**
```
sessions -u 1
```
This attempts to upgrade the shell to a Meterpreter session for advanced features.
May fail on minimal systems or if network conditions don't allow reverse connection.

## Pivoting Through Shell Session

If you need to reach internal networks through this compromised host:
```
# In msf6 console (not in shell)
route add <internal-subnet> <session-id>

# Example: Route 10.0.0.0/24 through session 1
route add 10.0.0.0/24 1
```

## Ask User Before Impactful Actions

Use `action="ask_user"` before:
- Privilege escalation attempts
- Password/hash dumping
- Persistence mechanisms
- File modifications
- Lateral movement
- Data exfiltration
"""


# =============================================================================
# POST-EXPLOITATION TOOLS (Stateless Mode)
# =============================================================================

POST_EXPLOITATION_TOOLS_STATELESS = """
### Post-Exploitation Phase Tools (Stateless Mode)

You are now in POST-EXPLOITATION phase. The exploit has been proven to work.
In stateless mode, you execute commands by re-running the exploit with different CMD values.

## IMPORTANT: Ask User What to Do!

**Before running any commands, ASK the user what they want to do:**
- Use `action="ask_user"` to get user direction
- Do NOT assume what the user wants based on their original request
- Present options like: reconnaissance, file access, defacement, persistence, etc.

**Workflow (after user specifies what to do):**
1. The exploit module should still be loaded from exploitation phase
2. Change the CMD option: `set CMD "<command>"`
3. Re-run: `exploit`
4. Capture output
5. Repeat for each command

**Typical post-exploitation actions (after user approval):**
- Check current user/privileges
- Gather system information
- List users and directories
- Read configuration files
- Check network connections

Use commands appropriate for the target OS (determined during exploitation).

**IMPORTANT:**
- Session-based tools (msf_sessions_list, msf_session_run, etc.) are NOT available in stateless mode
- ALWAYS ask user before performing destructive operations (file writes, data modification)
- Each command requires re-running the exploit
"""
